# 🎣 钓鱼佬的工具箱 (Angler's Toolbox)

> **作者**: 10091009mc
> **⚠️ 警告**: 不要买任何贩子的模型 API，都是骗人的！
> **🚫 声明**: 本脚本完全免费，仅供个人学习使用，严禁任何商业化行为。

针对 Android Termux 场景定制的 SillyTavern 一站式管家，覆盖安装、更新、修复、备份、保活、自动化与卸载。脚本当前版本为 **v1.3.5**，已在手机端实践验证，可最大限度降低部署与维护成本。

---

## 📘 项目简介

- 仅需一次命令即可获得完整工具箱，脚本会自动检测依赖、修复环境、处理端口占用并保留你的聊天数据。
- 大量「手机原生」方案（Termux API、静音音频、系统设置跳转）避免依赖电脑或 ADB。
- 所有危险操作均带多重确认，大幅降低误删数据的风险。

---

## ✨ 为什么选择钓鱼佬的工具箱

1. **面向手机**：完全基于 Termux，适配常见 ARM/ARM64 设备。
2. **运维闭环**：安装、更新、回退、备份、保活全覆盖。
3. **自带保活策略**：唤醒锁 + 0dB 静音音频 + 系统设置指南，真正抵御杀后台。
4. **自动化体验**：可选开机自启、自更新、第三方工具箱 (Foxium) 整合。

---

## 🚀 快速开始

1. 从 [F-Droid](https://f-droid.org/) 安装 Termux 与 Termux:API（静音音频保活必备）。
2. 打开 Termux，复制并执行：

   ```bash
   bash <(curl -s https://raw.githubusercontent.com/mc10091009/st_manager.sh/main/angler_toolbox.sh)
   ```

3. 首次运行脚本会自动：
   - 初始化依赖 (`curl/git/node/python/tar/jq/lsof/psmisc/procps/termux-api`)
   - 下载最新 SillyTavern
   - 引导你设置可选的开机自启

---

## 🧰 功能矩阵

### 🚀 基础管理

- 一键安装/启动 SillyTavern，自动检测端口冲突。
- 安装/更新时会展示可用版本数量及最近 Tag，可跟进 release/main 或精准切换 Tag / Commit。
- 重置 node_modules，解决 `npm install` 失败。

### 🛠️ 维护修复

- 多策略端口检测 (fuser/lsof/netstat/ss/pgrep) 并可强制清理。
- 集成 Foxium 工具箱（橘狐 FoX）以获取额外修复脚本。
- 卸载向导（脚本 / SillyTavern / 全清）附带随机验证码防误删。

### 💾 数据安全

- `~/st_backups` 自动归档 `data`, `config.yaml`, `secrets.json`, 第三方插件。
- 备份/恢复菜单支持跨目录选择 `.tar.gz/.tgz`，并附覆盖提醒。

### 🛡️ 保活与自动化

- Termux 唤醒锁快捷开关。
- 0dB 静音音频循环播放（自动校验文件大小，防止损坏）。
- 电池优化设置跳转 + 系统设置攻略（任务锁定/悬浮窗/自启动/通知）。
- 一键启停开机自启，自动清除旧版残留配置，修复“双重退出”问题。

---

## 📋 菜单速查

| 选项 | 功能               | 说明                                |
| ---- | ------------------ | ----------------------------------- |
| 1    | 启动 SillyTavern   | 自动补装依赖并运行 `node server.js` |
| 2    | 安装 SillyTavern   | 克隆仓库并 `npm install`            |
| 3    | 更新 SillyTavern   | 支持 release/main 与指定 Tag        |
| 4    | 版本回退/切换      | Commit/Tag 双模式，含 10 条历史提示 |
| 5    | 重装依赖 (Fix npm) | 清理 `node_modules` 后重新安装      |
| 6    | 备份与恢复         | 图形化选择备份/恢复点               |
| 7    | 端口检查与清理     | 多手段检测 8000 端口并可杀进程      |
| 8    | 防杀后台保活       | 唤醒锁 / 静音音频 / 电池优化指引    |
| 9    | 更新此脚本         | 自查/自更到最新 `angler_toolbox.sh` |
| 10   | 开机自启           | 自动写入/清理 `.bashrc` / `.zshrc`  |
| 11   | 卸载管理           | SillyTavern / 脚本 / 全部卸载       |
| 12   | 运行 Foxium 工具箱 | 下载并启动 FoX 的多功能脚本         |
| 0    | 退出脚本           | 安全退出主菜单                      |

---

## 🔄 更新 / 回退建议

- **日常更新**：选择菜单 `3`，默认 tracking `release` 分支；若仓库无 release，将自动 fallback 到 `origin/main`。
- **版本总览**：菜单 `2/3` 会显示 Tag 总数、最近版本以及当前分支/Tag，可直接输入序号或名称切换。
- **回退到稳定版**：使用菜单 `4 -> 版本号 Tag`，脚本会列出最近 10 个 Tag 供参考。
- **临时测试**：使用 `Commit Hash` 模式快速切换，操作前建议执行脚本提示的备份。

---

## 💾 备份与恢复要点

1. 在任意操作前执行脚本提示的备份可保留所有会话与配置。
2. 备份文件位于 `~/st_backups/st_backup_YYYYmmdd_HHMMSS.tar.gz`，可手动复制到其它介质。
3. 恢复时脚本会列出 Home 与备份目录内的所有压缩包，支持多份备份快速切换。
4. 恢复操作前有双确认，避免误覆盖。

---

## 🛡️ 保活策略详解

1. **Termux 唤醒锁**
   - 需安装 Termux:API。菜单 8-1/8-2 可一键开关，通知栏会显示状态。
2. **0dB 静音音频**
   - 自动校验音频文件大小，损坏时重新下载。后台循环播放可显著降低被系统杀掉的概率。
3. **系统设置攻略**
   - 菜单内提供最近任务上锁、悬浮窗、通知、自启动、电池优化等文字指南。
4. **电池优化快捷入口**
   - 脚本尝试拉起系统 Intent，失败时会返回手动路径。

> 建议组合：唤醒锁 + 静音音频 + 锁定最近任务 + 允许通知/自启动。

---

## ⚙️ 自动启动 (可选)

- 选择菜单 `10` 即可开启/关闭开机自启，脚本会自动写入 `.bashrc`/`.zshrc` 并保证 `.bash_profile` 正确加载。
- 内建「重复配置检测」，若发现旧版本残留，会提示自动修复，彻底解决“退出两次才关掉”的 bug。
- 若需要完全禁用自启，可通过 `10` 或 `卸载脚本` 自动清理所有相关片段。

---

## 📦 依赖列表

脚本会自动处理以下 Termux 包（缺失时自动安装/升级）：

`curl`, `git`, `nodejs`, `python`, `build-essential`, `tar`, `jq`, `lsof`, `psmisc` (含 `fuser`), `procps` (`pgrep`), `termux-api`

> 使用静音音频保活 / 唤醒锁 等功能请务必在系统端安装 Termux:API。

---

## ❓ 常见问题

**Q1. 为什么脚本要二次确认卸载？**
为避免误删会话数据，所有破坏性操作（卸载 SillyTavern/脚本/全清）都要求输入随机验证码。

**Q2. `npm install` 仍然失败？**
请检查网络或切换 npm 镜像，随后在菜单中再次运行「重装依赖」。脚本会重新下载 `node_modules` 并清理旧缓存。

**Q3. 启动提示端口占用但没有进程？**
菜单 7 提供多种检测方式并列出 pid；若依旧提示，可留意是否有残留 `node server.js` 进程并手动结束。

**Q4. 需要退出两次？**
v1.2.7+ 已加入重复配置扫描。如果问题复现，先在菜单 10 关闭再开启自启，或执行「更新此脚本」获取最新修复。

---

## 🗓️ 更新日志

- **v1.3.5**
  - 安装与更新菜单支持显示 Tag 数量，并可通过序号或名称精准选择版本。
  - 更新流程会提示当前分支/Tag/Commit，方便确认现状与目标。
  - 首次安装即可指定 release/main 或直接安装任意 Tag。

- **v1.3.4**
  - 新增首次运行自启自检与自动修复，彻底解决重复启动/双退出。
  - 强化自动安装脚本到 `$HOME` 的逻辑，curl|bash 与本地运行统一管理。
  - 引入 Foxium 工具箱一键入口，扩展修复与优化手段。
  - 端口检测、静音音频、卸载流程等模块全面打磨。

- **v1.2.7**
  - 修复自启导致的“双重退出”问题。
  - 移除依赖电脑/ADB 的保活方案，改为纯手机端实现。
  - 新增静音音频保活与系统设置指南。

- **v1.2.0**
  - 重构主菜单，分区展示功能，交互体验全面升级。

- **v1.0.0**
  - 初版发布，实现 SillyTavern 安装/启动/更新的核心流程。

---

> *Enjoy your SillyTavern on Android!* 🎣
> 如果该脚本帮助了你，欢迎在 GitHub 给作者点亮一个 ⭐️。
